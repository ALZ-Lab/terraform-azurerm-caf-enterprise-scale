---
name: "Test baseline (Update)"

trigger: none

pool:
  vmImage: ubuntu-20.04

variables:
  - group: csu-tf-environment

jobs:
  - job: get_pr_details
    displayName: "Get PR details from GitHub"
    steps:
      - task: Bash@3
        name: getPR
        displayName: "Query GitHub API"
        inputs:
          targetType: "inline"
          script: "make opa-update-check-pr"

  - job: update_opa_baseline
    dependsOn: get_pr_details
    displayName: "Update OPA baseline"
    variables:
      REPOSITORY_URI: $[ dependencies.get_pr_details.outputs['getPR.REPOSITORY_URI'] ]
      SOURCE_BRANCH: $[ dependencies.get_pr_details.outputs['getPR.SOURCE_BRANCH'] ]
    steps:
      - checkout: $[ dependencies.get_pr_details.outputs['getPR.REPOSITORY_URI'] ]
        persistCredentials: true

      - task: Bash@3
        name: showEnv
        displayName: "Show environment variables"
        inputs:
          targetType: "inline"
          script: "env | sort"

      - task: Bash@3
        name: getPR
        displayName: "Get details from PR"
        inputs:
          targetType: "inline"
          script: "make opa-update-check-pr"

      - task: PowerShell@2
        name: updateBaseline
        displayName: "Update OPA baseline values"
        inputs:
          targetType: "inline"
          script: "make opa-update-values"
        env:
          ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)

      - task: Bash@3
        name: mergeChanges
        displayName: "Merge changes to repository"
        inputs:
          targetType: "inline"
          script: "make opa-update-git"
