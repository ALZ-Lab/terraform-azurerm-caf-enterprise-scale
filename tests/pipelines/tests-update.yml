---
name: "Test baseline (Update)"

trigger: none

pool:
  vmImage: ubuntu-20.04

variables:
  - group: csu-tf-environment

jobs:
  - job: update_opa_baseline
    displayName: "Update OPA baseline"
    steps:
      - checkout: self
        persistCredentials: true

      - task: Bash@3
        displayName: "Show environment variables"
        inputs:
          targetType: "inline"
          script: "env | sort"

      - task: Bash@3
        displayName: "Authenticate GitHub CLI"
        inputs:
          targetType: "inline"
          script: |
            echo "==> Authenticating GitHub CLI..."
            echo "GitHub CLI should authenticate using the GITHUB_TOKEN environment variable."
            echo "If GITHUB_TOKEN is not found, please note that you will have 10 minutes"
            echo "to complete authentication using the web-based browser flow..."
            gh auth login
        timeoutInMinutes: 10
        env:
          GITHUB_TOKEN: $(GITHUB_TOKEN)

      - task: Bash@3
        displayName: "Checkout PR"
        inputs:
          targetType: "inline"
          script: "gh pr checkout $(System.PullRequest.PullRequestNumber)"

      - task: PowerShell@2
        displayName: "Update OPA baseline values"
        inputs:
          targetType: "inline"
          script: "make opa-update-values"
        env:
          ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)

      - task: Bash@3
        displayName: "Merge and push changes"
        inputs:
          targetType: "inline"
          script: "make opa-update-git"
        env:
          GITHUB_TOKEN: $(GITHUB_TOKEN)
